#!/usr/bin/env bash
# Git hook: pre-commit
# Formats code before commit
# Bypass: SKIP_PRE_COMMIT=1 git commit ...

# Allow bypass for emergency situations
if [[ "${SKIP_PRE_COMMIT:-}" == "1" ]]; then
  echo "‚ö†Ô∏è  Pre-commit checks skipped (SKIP_PRE_COMMIT=1)"
  exit 0
fi

echo "üìù Running pre-commit checks..."
echo ""

# Get the root of the git repository
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1
# shellcheck source=scripts/common_lib/automation/scope_resolver.sh
source "$REPO_ROOT/scripts/common_lib/automation/scope_resolver.sh"

# Protect integration branches from direct commits.
# Use ALLOW_PROTECTED_BRANCH_COMMIT=1 only for exceptional maintenance work.
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
if [[ "${ALLOW_PROTECTED_BRANCH_COMMIT:-}" != "1" ]] \
  && [[ "$CURRENT_BRANCH" == "dev" || "$CURRENT_BRANCH" == "main" ]]; then
  echo "‚ùå Direct commits on protected branch '$CURRENT_BRANCH' are blocked."
  echo "   Create a feature/fix/docs branch, then open a PR."
  echo "   Temporary bypass (exception only): ALLOW_PROTECTED_BRANCH_COMMIT=1 git commit ..."
  exit 1
fi

# Get affected crates
STAGED_CHANGED_FILES="$(git diff --cached --name-only --diff-filter=ACMRU)"
AFFECTED="$(collect_crates_from_files "$STAGED_CHANGED_FILES")"
if [[ -z "$AFFECTED" ]]; then
  echo "üéØ No Rust crates detected, checking all files"
else
  echo "üéØ Affected crates:"
  echo "$AFFECTED" | sed 's/^/   - /'
  echo ""
fi

# 1. Check orchestrator script permissions
echo "üîí Checking orchestrator script permissions..."
PERMISSION_ERRORS=0

# Check read/ scripts (must NOT be executable)
while IFS= read -r -d '' script; do
  if [[ -x "$script" ]]; then
    echo "   ‚ùå $script should NOT be executable (use chmod 644)"
    PERMISSION_ERRORS=$((PERMISSION_ERRORS + 1))
  fi
done < <(find scripts/versioning/file_versioning/orchestrators/read -name '*.sh' -type f -print0 2>/dev/null)

# Check execute/ scripts (must BE executable)
while IFS= read -r -d '' script; do
  if [[ ! -x "$script" ]]; then
    echo "   ‚ùå $script should be executable (use chmod 755)"
    PERMISSION_ERRORS=$((PERMISSION_ERRORS + 1))
  fi
done < <(find scripts/versioning/file_versioning/orchestrators/execute -name '*.sh' -type f -print0 2>/dev/null)

if [[ $PERMISSION_ERRORS -gt 0 ]]; then
  echo ""
  echo "‚ùå Script permission errors detected!"
  echo "   Convention: read/ scripts = 644, execute/ scripts = 755"
  exit 1
fi

# 2. Format staged files
echo "‚ú® Formatting code..."
if ! cargo fmt --all; then
  echo ""
  echo "‚ùå Formatting failed!"
  exit 1
fi

# Re-add only files that were already staged (avoid scooping unrelated changes)
mapfile -t STAGED_FILES < <(git diff --cached --name-only --diff-filter=ACMRU)
if [[ ${#STAGED_FILES[@]} -gt 0 ]]; then
  git add -- "${STAGED_FILES[@]}"
fi

echo "‚úÖ Pre-commit checks passed"
echo ""

exit 0
