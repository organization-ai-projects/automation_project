#!/usr/bin/env bash
# Git hook: pre-push
# Runs formatting, linting, and tests before push
# Bypass: SKIP_PRE_PUSH=1 git push ...

# Allow bypass for emergency situations
if [[ "${SKIP_PRE_PUSH:-}" == "1" ]]; then
  echo "âš ï¸  Pre-push checks skipped (SKIP_PRE_PUSH=1)"
  exit 0
fi

echo "ğŸ” Running pre-push checks..."
echo ""

# Get the root of the git repository
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

# Track overall status
FAILED=0

# 1. Check formatting
echo "ğŸ“ Checking code formatting..."
if ! cargo fmt --all --check; then
  echo ""
  echo "âŒ Code formatting check failed!"
  echo "   Run: cargo fmt --all"
  echo ""
  FAILED=1
else
  echo "âœ… Formatting OK"
  echo ""
fi

# 2. Run clippy
echo "ğŸ” Running clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
  echo ""
  echo "âŒ Clippy found issues!"
  echo "   Run: cargo clippy --all-targets --all-features -- -D warnings"
  echo ""
  FAILED=1
else
  echo "âœ… Clippy OK"
  echo ""
fi

# 3. Run tests
echo "ğŸ§ª Running tests..."
if ! cargo test --workspace; then
  echo ""
  echo "âŒ Tests failed!"
  echo "   Run: cargo test --workspace"
  echo ""
  FAILED=1
else
  echo "âœ… Tests OK"
  echo ""
fi

# Final result
if [[ $FAILED -eq 1 ]]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ Pre-push checks FAILED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Please fix the issues before pushing."
  echo "Bypass (emergency only): SKIP_PRE_PUSH=1 git push"
  echo ""
  exit 1
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-push checks PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

exit 0
