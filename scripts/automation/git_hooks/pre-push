#!/usr/bin/env bash
# Git hook: pre-push
# Runs scope-aware formatting, linting, and tests before push
# Bypass: SKIP_PRE_PUSH=1 git push ...
set -euo pipefail

if [[ "${SKIP_PRE_PUSH:-}" == "1" ]]; then
  echo "âš ï¸  Pre-push checks skipped (SKIP_PRE_PUSH=1)"
  exit 0
fi

echo "ğŸ” Running pre-push checks..."
echo ""

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1
HOOKS_DIR="$REPO_ROOT/scripts/automation/git_hooks"
# shellcheck source=scripts/automation/git_hooks/lib/push_policy.sh
source "$HOOKS_DIR/lib/push_policy.sh"
# shellcheck source=scripts/automation/git_hooks/lib/rust_checks.sh
source "$HOOKS_DIR/lib/rust_checks.sh"

UPSTREAM_BRANCH="$(hook_utils_resolve_upstream_branch)"
commits="$(hook_utils_collect_push_commits "$UPSTREAM_BRANCH")"

if ! push_policy_validate_no_root_parent_issue_refs "$commits"; then
  exit 1
fi

if ! push_policy_validate_part_of_only_push "$commits"; then
  exit 1
fi

changed_files="$(hook_utils_compute_changed_files "$UPSTREAM_BRANCH")"

if is_docs_or_scripts_only_change "$changed_files"; then
  echo "ğŸ“„ Docs/scripts-only changes detected."
  echo "ğŸ§ª Skipping Rust fmt/clippy/tests for this push."
  echo "ğŸ” Running lightweight shell syntax checks..."
  hook_utils_run_shell_syntax_checks "$changed_files"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ… Pre-push checks PASSED (docs/scripts-only mode)"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  exit 0
fi

AFFECTED="$(push_policy_detect_crates_from_scopes "$commits")"
SCOPE_VALID=$?

LOCKED_ARGS=()
if rust_checks_has_lockfile; then
  LOCKED_ARGS=(--locked)
fi

if [[ $SCOPE_VALID -ne 0 ]] || [[ -z "$AFFECTED" ]]; then
  AFFECTED="$(collect_crates_from_files "$changed_files")"
  if [[ -n "$AFFECTED" ]]; then
    echo "âš ï¸  Missing/invalid commit scopes - using changed files to infer crates."
    if [[ "${SCOPES_HAD_INVALID:-0}" -eq 1 ]]; then
      echo "   Tip: use scopes like 'refactor(projects/libraries/security):' or 'fix(projects/products/stable/accounts/backend):'"
    fi
    echo "ğŸ¯ Crates inferred from changed files:"
    echo "$AFFECTED" | sed 's/^/   - /'
    echo ""
    CLIPPY_ARGS=("${LOCKED_ARGS[@]}" --all-targets --all-features)
    TEST_ARGS=("${LOCKED_ARGS[@]}" --all-targets --all-features)
    while IFS= read -r crate; do
      [[ -z "$crate" ]] && continue
      CLIPPY_ARGS+=(-p "$crate")
      TEST_ARGS+=(-p "$crate")
    done <<< "$AFFECTED"
  else
    echo "âš ï¸  Could not infer affected crates - testing full workspace."
    echo "   (Use scopes like 'refactor(projects/libraries/security):' or 'fix(projects/products/stable/accounts/backend):')"
    echo ""
    CLIPPY_ARGS=("${LOCKED_ARGS[@]}" --workspace --all-targets --all-features)
    TEST_ARGS=("${LOCKED_ARGS[@]}" --workspace --all-targets --all-features)
  fi
else
  echo "ğŸ¯ Crates from commit scopes:"
  echo "$AFFECTED" | sed 's/^/   - /'
  echo ""
  CLIPPY_ARGS=("${LOCKED_ARGS[@]}" --all-targets --all-features)
  TEST_ARGS=("${LOCKED_ARGS[@]}" --all-targets --all-features)
  while IFS= read -r crate; do
    [[ -z "$crate" ]] && continue
    CLIPPY_ARGS+=(-p "$crate")
    TEST_ARGS+=(-p "$crate")
  done <<< "$AFFECTED"
fi

FAILED=0

echo "ğŸ“ Checking code formatting..."
if ! rust_checks_run_fmt_check; then
  echo ""
  echo "âŒ Code formatting check failed!"
  echo "   Run: cargo fmt --all"
  echo ""
  FAILED=1
else
  echo "âœ… Formatting OK"
  echo ""
fi

echo "ğŸ” Running clippy..."
if ! rust_checks_run_clippy "${CLIPPY_ARGS[@]}"; then
  echo ""
  echo "âŒ Clippy found issues!"
  echo "   Run: cargo clippy ${CLIPPY_ARGS[*]} -- -D warnings"
  echo ""
  FAILED=1
else
  echo "âœ… Clippy OK"
  echo ""
fi

echo "ğŸ§ª Running tests..."
if ! rust_checks_run_tests "${TEST_ARGS[@]}"; then
  echo ""
  echo "âŒ Tests failed!"
  echo "   Run: cargo test ${TEST_ARGS[*]}"
  echo ""
  FAILED=1
else
  echo "âœ… Tests OK"
  echo ""
fi

if [[ $FAILED -eq 1 ]]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ Pre-push checks FAILED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Please fix the issues before pushing."
  echo "Bypass (emergency only): SKIP_PRE_PUSH=1 git push"
  echo ""
  exit 1
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-push checks PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

exit 0
