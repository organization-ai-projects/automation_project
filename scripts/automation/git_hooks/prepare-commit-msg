#!/usr/bin/env bash
# Git hook: prepare-commit-msg
# Auto-generates a conventional commit subject from branch name and staged files.
# Bypass: SKIP_PREPARE_COMMIT_MSG=1 git commit ...
set -euo pipefail

COMMIT_MSG_FILE="${1:-}"
COMMIT_SOURCE="${2:-}"
ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || true)"

if [[ -z "$COMMIT_MSG_FILE" || ! -f "$COMMIT_MSG_FILE" ]]; then
  exit 0
fi

# Keep explicit user messages and special commit flows untouched.
if [[ "$COMMIT_SOURCE" == "message" || "$COMMIT_SOURCE" == "merge" || "$COMMIT_SOURCE" == "squash" || "$COMMIT_SOURCE" == "commit" ]]; then
  exit 0
fi

if [[ "${SKIP_PREPARE_COMMIT_MSG:-}" == "1" ]]; then
  exit 0
fi

# Do not override non-empty messages (ignoring comments and blank lines).
if grep -Eq '^[[:space:]]*[^#[:space:]].*$' "$COMMIT_MSG_FILE"; then
  exit 0
fi

BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || true)"
if [[ -z "$BRANCH" || "$BRANCH" == "HEAD" ]]; then
  exit 0
fi

# shellcheck source=scripts/automation/git_hooks/lib/commit_message_policy.sh
source "$ROOT_DIR/scripts/automation/git_hooks/lib/commit_message_policy.sh"
# shellcheck source=scripts/automation/git_hooks/lib/scope_resolver.sh
source "$ROOT_DIR/scripts/automation/git_hooks/lib/scope_resolver.sh"

STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACMRU)"
if [[ -z "$STAGED_FILES" ]]; then
  exit 0
fi

# Prioritize staged-file intent over branch prefix so one branch can host
# multiple commit types (e.g., docs + test + feat commits).
if is_docs_only_change "$STAGED_FILES"; then
  TYPE="docs"
elif is_tests_only_change "$STAGED_FILES"; then
  TYPE="test"
else
  TYPE="$(map_branch_type "$BRANCH")"
  if [[ -z "$TYPE" ]]; then
    TYPE="chore"
    TYPE_FALLBACK_WARNING="# WARNING: branch prefix not recognized; defaulted type to 'chore'."
  fi
fi

SCOPES="$(detect_required_scopes_from_staged_files)"
SCOPES_CSV="$(join_scopes_csv "$SCOPES")"
DESCRIPTION="$(derive_description "$BRANCH" "$STAGED_FILES")"

if [[ -z "$SCOPES_CSV" ]]; then
  SCOPES_CSV="workspace"
fi

SUBJECT="${TYPE}(${SCOPES_CSV}): ${DESCRIPTION}"

{
  echo "$SUBJECT"
  echo
  echo "# Auto-generated from branch '$BRANCH' and staged files."
  [[ -n "${TYPE_FALLBACK_WARNING:-}" ]] && echo "$TYPE_FALLBACK_WARNING"
  echo "# Edit freely before saving this commit."
} > "$COMMIT_MSG_FILE"

exit 0
