name: Parent Issue Guard

on:
  issues:
    types: [opened, edited, reopened, closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to evaluate as parent"
        required: false

permissions:
  issues: write
  contents: read

jobs:
  parent-issue-status:
    if: github.event.issue.pull_request == null
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Evaluate issue as parent candidate
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          bash scripts/versioning/file_versioning/github/parent_issue_guard.sh \
            --issue "$ISSUE_NUMBER" \
            --strict-guard true

      - name: Evaluate parent candidates from changed child
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          bash scripts/versioning/file_versioning/github/parent_issue_guard.sh \
            --child "$ISSUE_NUMBER" \
            --strict-guard true

      - name: Manual parent evaluation
        if: github.event_name == 'workflow_dispatch' && inputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          if [[ ! "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Invalid issue_number '$ISSUE_NUMBER' (expected positive integer)." >&2
            exit 1
          fi
          bash scripts/versioning/file_versioning/github/parent_issue_guard.sh \
            --issue "$ISSUE_NUMBER" \
            --strict-guard true
